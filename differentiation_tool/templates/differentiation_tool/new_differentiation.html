{% extends "differentiation_tool/base.html" %}

{% block title %}New Differentiation - DiffF{% endblock %}

{% block content %}
<div class="container">
    <div class="card card-accent">
        <h1 class="card-title">Differentiate a New Lesson</h1>
        <p class="card-subtitle">Phase 1: Input your lesson material and select students</p>

        <div class="phase-indicator">
            <div class="phase-step active">
                <div class="phase-circle">1</div>
                <div class="phase-label">Input</div>
            </div>
            <div class="phase-step">
                <div class="phase-circle">2</div>
                <div class="phase-label">Suggestions</div>
            </div>
            <div class="phase-step">
                <div class="phase-circle">3</div>
                <div class="phase-label">Refine</div>
            </div>
            <div class="phase-step">
                <div class="phase-circle">4</div>
                <div class="phase-label">Generate</div>
            </div>
        </div>

        <form method="POST" data-validate>
            <div class="form-group">
                <label for="title" class="form-label">Lesson Title *</label>
                <input type="text" id="title" name="title" class="form-control"
                       placeholder="e.g., OOP Project: Design a 'Pet' class" required>
            </div>

            <div class="form-group">
                <label for="material" class="form-label">Original Lesson Material *</label>
                <textarea id="material" name="material" class="form-control" rows="10" required
                          placeholder="Paste your lesson, assignment, or activity here..."></textarea>
                <small class="text-muted">Include instructions, learning objectives, and any relevant details</small>
            </div>

            <div class="form-group">
                <label class="form-label">Select Students *</label>
                {% if students %}
                <div style="max-height: 250px; overflow-y: auto; border: 2px solid var(--border-light); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    {% for student in students %}
                    <div class="form-check">
                        <input type="checkbox" id="student_{{ student['id'] }}" name="students"
                               value="{{ student['id'] }}" class="form-check-input">
                        <label for="student_{{ student['id'] }}" class="form-check-label">
                            {{ student['first_name'] }} {{ student['last_name'] }}
                            {% if student['accommodations'] %}
                            <span class="text-muted" style="font-size: 0.85rem;">- {{ student['accommodations'][:40] }}{% if student['accommodations']|length > 40 %}...{% endif %}</span>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">You need to add students first.
                    <a href="{{ url_for('differentiation.add_student') }}">Add a student</a>
                </p>
                {% endif %}
            </div>

            {% if groups %}
            <div class="form-group">
                <label class="form-label">Or Select Groups</label>
                <div style="border: 2px solid var(--border-light); border-radius: 8px; padding: 1rem;">
                    {% for group in groups %}
                    <div class="form-check">
                        <input type="checkbox" id="group_{{ group['id'] }}" name="groups"
                               value="{{ group['id'] }}" class="form-check-input">
                        <label for="group_{{ group['id'] }}" class="form-check-label">
                            {{ group['name'] }}
                            <span class="text-muted" style="font-size: 0.85rem;">({{ group['member_count'] }} students)</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="form-group">
                <label class="form-label">Select Curriculum Standards (Optional)</label>
                <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 0.75rem;">
                    Choose specific Introduction to Computer Science standards you want to focus on. If none are selected, the AI will have access to all standards.
                </p>
                <details style="border: 2px solid var(--border-light); border-radius: 8px; padding: 1rem;">
                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 1rem; user-select: none;">
                        Click to view and select standards
                    </summary>
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% if curriculum_standards %}
                            {% set current_domain = namespace(value='') %}
                            {% set current_standard = namespace(value='') %}
                            {% for std in curriculum_standards %}
                                {% if std['domain'] != current_domain.value %}
                                    {% if current_domain.value != '' %}
                                        </div></div>
                                    {% endif %}
                                    {% set current_domain.value = std['domain'] %}
                                    <div style="margin-bottom: 1.5rem;">
                                        <h4 style="color: var(--primary-color); font-size: 1rem; margin-bottom: 0.5rem;">
                                            {{ std['domain'] }}: {{ std['domain_title'] }}
                                        </h4>
                                        <div style="margin-left: 1rem;">
                                    {% set current_standard.value = '' %}
                                {% endif %}
                                {% if std['standard'] != current_standard.value %}
                                    {% if current_standard.value != '' %}
                                        </div>
                                    {% endif %}
                                    {% set current_standard.value = std['standard'] %}
                                    <div style="margin-bottom: 1rem;">
                                        <h5 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-dark);">
                                            {{ std['standard'] }}: {{ std['standard_title'][:60] }}{% if std['standard_title']|length > 60 %}...{% endif %}
                                        </h5>
                                        <div style="margin-left: 1rem;">
                                {% endif %}
                                <div class="form-check" style="margin-bottom: 0.3rem;">
                                    <input type="checkbox" id="std_{{ std['code'] }}" name="standards"
                                           value="{{ std['code'] }}" class="form-check-input">
                                    <label for="std_{{ std['code'] }}" class="form-check-label" style="font-size: 0.85rem;">
                                        <strong>{{ std['code'] }}:</strong> {{ std['text'][:100] }}{% if std['text']|length > 100 %}...{% endif %}
                                    </label>
                                </div>
                            {% endfor %}
                            {% if current_standard.value != '' %}
                                </div></div>
                            {% endif %}
                            {% if current_domain.value != '' %}
                                </div></div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No curriculum standards available.</p>
                        {% endif %}
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light);">
                        <button type="button" onclick="selectAllStandards()" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                            Select All
                        </button>
                        <button type="button" onclick="deselectAllStandards()" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; margin-left: 0.5rem;">
                            Deselect All
                        </button>
                        <span id="standards-count" style="margin-left: 1rem; font-size: 0.85rem; color: var(--text-muted);"></span>
                    </div>
                </details>
            </div>

            <script>
                function selectAllStandards() {
                    document.querySelectorAll('input[name="standards"]').forEach(cb => cb.checked = true);
                    updateStandardsCount();
                }
                function deselectAllStandards() {
                    document.querySelectorAll('input[name="standards"]').forEach(cb => cb.checked = false);
                    updateStandardsCount();
                }
                function updateStandardsCount() {
                    const count = document.querySelectorAll('input[name="standards"]:checked').length;
                    const countEl = document.getElementById('standards-count');
                    if (count > 0) {
                        countEl.textContent = count + ' standard' + (count !== 1 ? 's' : '') + ' selected';
                    } else {
                        countEl.textContent = 'No standards selected (AI will use all)';
                    }
                }
                document.querySelectorAll('input[name="standards"]').forEach(cb => {
                    cb.addEventListener('change', updateStandardsCount);
                });
                updateStandardsCount();
            </script>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">Continue to Suggestions →</button>
                <a href="{{ url_for('differentiation.dashboard') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
